{% extends "base.html" %}

{% block title %}Jobs - Graboid{% endblock %}

{% block content %}
<h1>Job Queue</h1>

<div class="grid-2">
    <div class="card">
        <h2>Submit New Job</h2>
        <form id="job-form">
            <label for="prompt">Task Description</label>
            <textarea id="prompt" name="prompt" rows="3" placeholder="Find and download the latest release of..." required></textarea>

            <label for="source_url">Starting URL (optional)</label>
            <input type="url" id="source_url" name="source_url" placeholder="https://example.com">

            <label for="destination_path">Destination Path</label>
            <input type="text" id="destination_path" name="destination_path" placeholder="./downloads" value="./downloads">

            <div class="grid-2">
                <div>
                    <label for="file_operation">File Operation</label>
                    <select id="file_operation" name="file_operation">
                        <option value="copy">Copy</option>
                        <option value="hardlink">Hard Link</option>
                        <option value="symlink">Symbolic Link</option>
                        <option value="reflink">Reflink (CoW)</option>
                        <option value="path_only">Path Only</option>
                    </select>
                </div>
                <div>
                    <label for="priority">Priority</label>
                    <input type="number" id="priority" name="priority" value="0" min="-10" max="10">
                </div>
            </div>

            <label for="file_filter">File Filter (glob patterns, one per line)</label>
            <textarea id="file_filter" name="file_filter" rows="2" placeholder="*.mkv&#10;*.mp4"></textarea>

            <button type="submit">Submit Job</button>
        </form>
        <div id="submit-result" style="margin-top: 1rem;"></div>
    </div>

    <div class="card">
        <h2>API Access</h2>
        <p style="color: var(--text-dim); margin-bottom: 1rem;">Use the API to submit jobs programmatically.</p>

        <label>API Key</label>
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
            <input type="password" id="api-key" value="{{ api_key }}" readonly style="font-family: monospace; flex: 1;">
            <button type="button" onclick="toggleApiKey()" class="secondary" style="padding: 0.5rem 1rem;">Show</button>
            <button type="button" onclick="copyApiKey()" class="secondary" style="padding: 0.5rem 1rem;">Copy</button>
        </div>

        <label>Example Request</label>
        <pre style="background: var(--bg); padding: 1rem; border-radius: 0.25rem; overflow-x: auto; font-size: 0.8rem;">
curl -X POST {{ request.url.scheme }}://{{ request.url.netloc }}/api/v1/jobs \
  -H "X-API-Key: YOUR_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "Download latest release",
    "source_url": "https://example.com"
  }'</pre>

        <label style="margin-top: 1rem;">Endpoints</label>
        <table style="font-size: 0.875rem;">
            <tr><td><code>POST /api/v1/jobs</code></td><td>Submit job</td></tr>
            <tr><td><code>GET /api/v1/jobs</code></td><td>List jobs</td></tr>
            <tr><td><code>GET /api/v1/jobs/{id}</code></td><td>Get job details</td></tr>
            <tr><td><code>DELETE /api/v1/jobs/{id}</code></td><td>Cancel job</td></tr>
            <tr><td><code>GET /api/v1/jobs/{id}/stream</code></td><td>SSE progress stream</td></tr>
        </table>
    </div>
</div>

<div class="card">
    <h2>Job Queue</h2>
    <div style="margin-bottom: 1rem;">
        <button type="button" onclick="refreshJobs()" class="secondary">Refresh</button>
    </div>
    <table id="jobs-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Status</th>
                <th>Progress</th>
                <th>Task</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="jobs-tbody">
            {% for job in jobs %}
            <tr id="job-{{ job.id }}">
                <td><code title="{{ job.id }}">{{ job.id[:8] }}</code></td>
                <td>
                    <span class="tag
                        {% if job.status == 'complete' %}success
                        {% elif job.status == 'failed' or job.status == 'cancelled' %}error
                        {% elif job.status in ['running', 'browsing', 'downloading', 'extracting', 'copying'] %}warning
                        {% endif %}">
                        {{ job.status }}
                    </span>
                </td>
                <td>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="flex: 1; background: var(--bg-light); border-radius: 0.25rem; height: 8px;">
                            <div style="width: {{ job.progress_percent }}%; background: var(--accent); height: 100%; border-radius: 0.25rem; transition: width 0.3s;"></div>
                        </div>
                        <span style="font-size: 0.75rem; color: var(--text-dim);">{{ job.progress_percent_display }}%</span>
                    </div>
                    {% if job.progress_message %}
                    <div style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.25rem;">{{ job.progress_message[:50] }}</div>
                    {% endif %}
                </td>
                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">{{ job.prompt[:50] }}{% if job.prompt|length > 50 %}...{% endif %}</td>
                <td style="font-size: 0.875rem; color: var(--text-dim);">{{ job.created_at_display }}</td>
                <td>
                    {% if job.status in ['pending', 'running', 'browsing', 'downloading', 'extracting', 'copying'] %}
                    <button type="button" onclick="cancelJob('{{ job.id }}')" class="secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Cancel</button>
                    {% else %}
                    <button type="button" onclick="requeueJob('{{ job.id }}')" class="secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Re-queue</button>
                    {% endif %}
                    <button type="button" onclick="viewJob('{{ job.id }}')" class="secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View</button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" style="text-align: center; color: var(--text-dim); padding: 2rem;">No jobs in queue</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Job Details Modal -->
<div id="job-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; padding: 2rem;">
    <div style="max-width: 800px; margin: 0 auto; background: var(--bg-card); border-radius: 0.5rem; padding: 1.5rem; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2>Job Details</h2>
            <button type="button" onclick="closeModal()" class="secondary">Close</button>
        </div>
        <div id="job-details"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const apiKey = "{{ api_key }}";

function toggleApiKey() {
    const input = document.getElementById('api-key');
    input.type = input.type === 'password' ? 'text' : 'password';
}

function copyApiKey() {
    navigator.clipboard.writeText(apiKey);
    alert('API key copied to clipboard');
}

document.getElementById('job-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const resultDiv = document.getElementById('submit-result');

    const fileFilter = form.file_filter.value.split('\n').filter(f => f.trim());

    const payload = {
        prompt: form.prompt.value,
        source_url: form.source_url.value,
        destination_path: form.destination_path.value,
        file_operation: form.file_operation.value,
        priority: parseInt(form.priority.value),
        file_filter: fileFilter,
    };

    try {
        const resp = await fetch('/api/v1/jobs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-API-Key': apiKey,
            },
            body: JSON.stringify(payload),
        });

        const data = await resp.json();

        if (resp.ok) {
            resultDiv.innerHTML = `<div class="alert success">Job submitted: ${data.id}</div>`;
            form.reset();
            await refreshJobs();
        } else {
            resultDiv.innerHTML = `<div class="alert error">Error: ${data.detail || data.error}</div>`;
        }
    } catch (err) {
        resultDiv.innerHTML = `<div class="alert error">Error: ${err.message}</div>`;
    }
});

async function refreshJobs() {
    try {
        const resp = await fetch('/api/v1/jobs?limit=50', {
            headers: { 'X-API-Key': apiKey },
        });
        const data = await resp.json();

        const tbody = document.getElementById('jobs-tbody');
        if (data.jobs && data.jobs.length > 0) {
            tbody.innerHTML = data.jobs.map(job => `
                <tr id="job-${job.id}">
                    <td><code title="${job.id}">${job.id.substring(0, 8)}</code></td>
                    <td>
                        <span class="tag ${getStatusClass(job.status)}">
                            ${job.status}
                        </span>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="flex: 1; background: var(--bg-light); border-radius: 0.25rem; height: 8px;">
                                <div style="width: ${job.progress_percent}%; background: var(--accent); height: 100%; border-radius: 0.25rem; transition: width 0.3s;"></div>
                            </div>
                            <span style="font-size: 0.75rem; color: var(--text-dim);">${Math.round(job.progress_percent)}%</span>
                        </div>
                        ${job.progress_message ? `<div style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.25rem;">${job.progress_message.substring(0, 50)}</div>` : ''}
                    </td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${job.prompt.substring(0, 50)}${job.prompt.length > 50 ? '...' : ''}</td>
                    <td style="font-size: 0.875rem; color: var(--text-dim);">${new Date(job.created_at).toLocaleString()}</td>
                    <td>
                        ${isActive(job.status)
                            ? `<button type="button" onclick="cancelJob('${job.id}')" class="secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Cancel</button>`
                            : `<button type="button" onclick="requeueJob('${job.id}')" class="secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Re-queue</button>`}
                        <button type="button" onclick="viewJob('${job.id}')" class="secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View</button>
                    </td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-dim); padding: 2rem;">No jobs in queue</td></tr>';
        }
    } catch (err) {
        console.error('Failed to refresh jobs:', err);
    }
}

function getStatusClass(status) {
    if (status === 'complete') return 'success';
    if (status === 'failed' || status === 'cancelled') return 'error';
    if (['running', 'browsing', 'downloading', 'extracting', 'copying'].includes(status)) return 'warning';
    return '';
}

function isActive(status) {
    return ['pending', 'running', 'browsing', 'downloading', 'extracting', 'copying'].includes(status);
}

async function cancelJob(jobId) {
    if (!confirm('Cancel this job?')) return;

    try {
        const resp = await fetch(`/api/v1/jobs/${jobId}`, {
            method: 'DELETE',
            headers: { 'X-API-Key': apiKey },
        });

        if (resp.ok) {
            await refreshJobs();
        } else {
            const data = await resp.json();
            alert('Failed to cancel: ' + (data.detail || 'Unknown error'));
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

async function requeueJob(jobId) {
    try {
        // Fetch the original job details
        const resp = await fetch(`/api/v1/jobs/${jobId}`, {
            headers: { 'X-API-Key': apiKey },
        });

        if (!resp.ok) {
            alert('Failed to fetch job details');
            return;
        }

        const job = await resp.json();

        // Create a new job with the same parameters
        const payload = {
            prompt: job.prompt,
            source_url: job.source_url || '',
            destination_path: job.destination_path || '',
            file_operation: job.file_operation || 'copy',
            priority: job.priority || 0,
            file_filter: job.file_filter || [],
            credential_name: job.credential_name || null,
            metadata: job.metadata || {},
        };

        const createResp = await fetch('/api/v1/jobs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-API-Key': apiKey,
            },
            body: JSON.stringify(payload),
        });

        if (createResp.ok) {
            const newJob = await createResp.json();
            document.getElementById('submit-result').innerHTML =
                `<div class="alert success">Job re-queued: ${newJob.id}</div>`;
            await refreshJobs();
        } else {
            const data = await createResp.json();
            alert('Failed to re-queue: ' + (data.detail || 'Unknown error'));
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

let currentJobId = null;
let screenshotRefreshInterval = null;
let showRawLogs = false;

async function viewJob(jobId) {
    currentJobId = jobId;
    loadedStepNumbers = new Set();
    showRawLogs = false;
    logSeenIds.clear();

    try {
        const resp = await fetch(`/api/v1/jobs/${jobId}`, {
            headers: { 'X-API-Key': apiKey },
        });
        const job = await resp.json();

        const details = document.getElementById('job-details');
        const active = isActive(job.status);
        details.innerHTML = `
            <!-- Header: status + task info -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <code>${job.id.substring(0, 8)}</code>
                    <span id="job-status" class="tag ${getStatusClass(job.status)}">${job.status}</span>
                    <span id="job-phase" style="color: var(--text-dim); font-size: 0.85rem;">${job.current_phase}</span>
                    <span id="job-progress" style="color: var(--text-dim); font-size: 0.85rem;">${Math.round(job.progress_percent)}%</span>
                </div>
                <span id="job-updated" style="color: var(--text-dim); font-size: 0.75rem;">${new Date(job.updated_at).toLocaleString()}</span>
            </div>

            <div style="margin-bottom: 1rem; padding: 0.5rem 0.75rem; background: var(--bg); border-radius: 0.25rem; display: flex; gap: 1rem; align-items: center;">
                <span id="job-progress-message" style="flex: 1;">${job.progress_message || 'Waiting...'}</span>
                ${job.source_url ? `<a href="${job.source_url}" target="_blank" style="color: var(--accent); font-size: 0.85rem; white-space: nowrap;">${job.source_url}</a>` : ''}
            </div>

            <div id="job-error" class="alert error" style="margin-bottom: 1rem; ${job.error_message ? '' : 'display:none;'}">${job.error_message ? escapeHtml(job.error_message) : ''}</div>

            <!-- Live view: browser + terminal side by side -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                <div>
                    <div style="color: var(--text-dim); font-size: 0.75rem; margin-bottom: 0.5rem;">
                        Browser View ${active ? '<span id="job-live-indicator" style="color: #4ecdc4; animation: pulse 2s infinite;">LIVE</span>' : ''}
                    </div>
                    <div id="job-screenshot-container" style="background: #000; border-radius: 0.5rem; aspect-ratio: 16/10; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        <div id="job-screenshot-placeholder" style="color: var(--text-dim);">${active ? '<span style="animation: pulse 2s infinite;">Starting browser...</span>' : 'No screenshots yet'}</div>
                        <img id="job-screenshot" style="display: none; max-width: 100%; max-height: 100%; object-fit: contain;">
                    </div>
                    <div id="job-screenshot-url" style="font-size: 0.7rem; color: var(--text-dim); margin-top: 0.25rem; word-break: break-all;"></div>
                </div>

                <div>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                        <div style="color: var(--text-dim); font-size: 0.75rem;">
                            Claude Output ${active ? '<span style="color: #4ecdc4; animation: pulse 2s infinite;">LIVE</span>' : ''}
                        </div>
                        <label style="font-size: 0.7rem; color: var(--text-dim); display: flex; align-items: center; gap: 0.35rem;">
                            <input type="checkbox" id="job-logs-raw-toggle" style="width: auto;" onchange="toggleRawLogs(this.checked)">
                            Raw CLI
                        </label>
                    </div>
                    <div id="job-logs" style="background: #0d1117; border-radius: 0.5rem; padding: 0.75rem; height: 280px; overflow-y: auto; font-family: monospace; font-size: 0.7rem; line-height: 1.4;">
                        <div style="color: var(--text-dim);">${active ? 'Waiting for browser launch...' : 'Waiting for output...'}</div>
                    </div>
                </div>
            </div>

            <style>
                @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
            </style>

            <!-- Step Cards -->
            <div style="margin-bottom: 1.5rem;">
                <h3>Navigation Steps</h3>
                <div id="job-step-cards" style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.75rem;">
                    <div style="color: var(--text-dim); padding: 0.5rem;">No steps yet...</div>
                </div>
            </div>

            <!-- Results sections -->
            <div id="job-found-urls" style="${job.found_urls && job.found_urls.length > 0 ? '' : 'display:none;'}">
                <h3>Found URLs (<span id="job-found-urls-count">${(job.found_urls || []).length}</span>)</h3>
                <ul id="job-found-urls-list" style="margin-top: 0.5rem; padding-left: 1.5rem; max-height: 150px; overflow-y: auto;">
                    ${(job.found_urls || []).map(u => `<li style="word-break: break-all;"><a href="${u}" target="_blank" style="color: var(--accent);">${u}</a></li>`).join('')}
                </ul>
            </div>

            <div id="job-downloaded-files" style="${job.downloaded_files && job.downloaded_files.length > 0 ? '' : 'display:none;'}">
                <h3 style="margin-top: 1rem;">Downloaded Files (<span id="job-downloaded-count">${(job.downloaded_files || []).length}</span>)</h3>
                <ul id="job-downloaded-list" style="margin-top: 0.5rem; padding-left: 1.5rem;">
                    ${(job.downloaded_files || []).map(f => `<li style="word-break: break-all;"><code>${f}</code></li>`).join('')}
                </ul>
            </div>

            <div id="job-final-paths" style="${job.final_paths && job.final_paths.length > 0 ? '' : 'display:none;'}">
                <h3 style="margin-top: 1rem;">Final Paths (<span id="job-final-count">${(job.final_paths || []).length}</span>)</h3>
                <ul id="job-final-list" style="margin-top: 0.5rem; padding-left: 1.5rem;">
                    ${(job.final_paths || []).map(f => `<li style="word-break: break-all;"><code>${f}</code></li>`).join('')}
                </ul>
            </div>

            <!-- Agent Notes -->
            <div style="margin-top: 1.5rem;">
                <h3>Agent Notes</h3>
                <div id="job-notes" style="margin-top: 0.5rem;">
                    <div style="color: var(--text-dim);">No notes yet.</div>
                </div>
            </div>
        `;

        document.getElementById('job-modal').style.display = 'block';
        const rawToggle = document.getElementById('job-logs-raw-toggle');
        if (rawToggle) rawToggle.checked = false;

        // Show result banner for completed/failed jobs
        renderResultBanner(job);

        // Load existing data
        await loadJobSteps(jobId);
        await loadJobLatestScreenshot(jobId);
        await refreshLogs();
        await loadNotes();

        // Start live updates (will stop automatically when job finishes)
        startLiveUpdates(jobId);
    } catch (err) {
        alert('Error loading job: ' + err.message);
    }
}

async function loadJobScreenshots(jobId) {
    try {
        const resp = await fetch(`/api/v1/jobs/${jobId}/screenshots`, {
            headers: { 'X-API-Key': apiKey },
        });
        const data = await resp.json();

        if (data.screenshots && data.screenshots.length > 0) {
            const latest = data.screenshots[data.screenshots.length - 1];
            const img = document.getElementById('job-screenshot');
            const placeholder = document.getElementById('job-screenshot-placeholder');
            const urlEl = document.getElementById('job-screenshot-url');

            if (latest.data_base64) {
                img.src = 'data:image/png;base64,' + latest.data_base64;
                img.style.display = 'block';
                placeholder.style.display = 'none';
            }
            if (urlEl && latest.url) {
                urlEl.textContent = latest.url;
            }
        }
    } catch (err) {
        console.error('Failed to load screenshots:', err);
    }
}

async function loadJobLatestScreenshot(jobId) {
    try {
        const resp = await fetch(`/api/v1/jobs/${jobId}/screenshots/latest`, {
            headers: { 'X-API-Key': apiKey },
        });
        const data = await resp.json();

        if (data.screenshot && data.screenshot.data_base64) {
            const img = document.getElementById('job-screenshot');
            const placeholder = document.getElementById('job-screenshot-placeholder');
            const urlEl = document.getElementById('job-screenshot-url');

            img.src = 'data:image/png;base64,' + data.screenshot.data_base64;
            img.style.display = 'block';
            placeholder.style.display = 'none';
            if (urlEl && data.screenshot.url) {
                urlEl.textContent = data.screenshot.url;
            }
        }
    } catch (err) {
        console.error('Failed to load latest screenshot:', err);
    }
}

let loadedStepNumbers = new Set();

function renderStepCard(step) {
    const card = document.createElement('div');
    card.id = `step-card-${step.step_number}`;
    card.style.cssText = `padding: 0.75rem; background: var(--bg); border-radius: 0.5rem; border-left: 4px solid ${step.is_error ? 'var(--error)' : 'var(--accent)'};`;

    let html = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <div style="font-weight: 600; font-size: 0.85rem; color: ${step.is_error ? 'var(--error)' : 'var(--text)'};">
                Step ${step.step_number}: ${escapeHtml(step.action)}
            </div>
            <div style="font-size: 0.7rem; color: var(--text-dim);">${step.timestamp ? new Date(step.timestamp).toLocaleTimeString() : ''}</div>
        </div>`;

    if (step.screenshot_base64) {
        html += `<div style="margin-bottom: 0.5rem; cursor: pointer;" onclick="this.querySelector('img').style.maxHeight = this.querySelector('img').style.maxHeight === 'none' ? '200px' : 'none';">
            <img src="data:image/png;base64,${step.screenshot_base64}" style="width: 100%; max-height: 200px; object-fit: contain; border-radius: 0.25rem; background: #000;">
        </div>`;
    } else {
        html += `<div class="step-screenshot-placeholder" style="margin-bottom: 0.5rem; height: 120px; background: #111; border-radius: 0.25rem; display: flex; align-items: center; justify-content: center; color: var(--text-dim); font-size: 0.75rem;">
            <span style="animation: pulse 2s infinite;">Capturing screenshot...</span>
        </div>`;
    }

    if (step.observation) {
        html += `<div style="color: var(--text-dim); font-size: 0.85rem;">${escapeHtml(step.observation)}</div>`;
    }

    if (step.url) {
        html += `<div style="margin-top: 0.25rem; font-size: 0.75rem; color: var(--accent); word-break: break-all;">${escapeHtml(step.url)}</div>`;
    }

    if (step.notes && step.notes.length > 0) {
        html += `<div data-step-notes="1" style="margin-top: 0.5rem; padding: 0.4rem 0.6rem; background: rgba(78, 205, 196, 0.1); border-radius: 0.25rem; font-size: 0.8rem;">`;
        step.notes.forEach(note => {
            html += `<div style="color: #4ecdc4;">${escapeHtml(note)}</div>`;
        });
        html += `</div>`;
    }

    card.innerHTML = html;
    return card;
}

async function loadJobSteps(jobId) {
    const container = document.getElementById('job-step-cards');
    if (!container) return;

    try {
        const resp = await fetch(`/api/v1/jobs/${jobId}/steps/detail`, {
            headers: { 'X-API-Key': apiKey },
        });
        const data = await resp.json();

        if (data.steps && data.steps.length > 0) {
            // On first load, rebuild all cards
            if (loadedStepNumbers.size === 0) {
                container.innerHTML = '';
                data.steps.forEach(step => {
                    loadedStepNumbers.add(step.step_number);
                    container.appendChild(renderStepCard(step));
                });
            } else {
                // Incremental: only add new steps
                data.steps.forEach(step => {
                    if (!loadedStepNumbers.has(step.step_number)) {
                        loadedStepNumbers.add(step.step_number);
                        container.appendChild(renderStepCard(step));
                    } else {
                        // Update existing card if screenshot arrived
                        const existing = document.getElementById(`step-card-${step.step_number}`);
                        const hasImage = existing && existing.querySelector('img');
                        const hasNotes = existing && existing.querySelector('[data-step-notes]');
                        if (existing && ((step.screenshot_base64 && !hasImage) || (step.notes && step.notes.length > 0 && !hasNotes))) {
                            // Re-render card with new screenshot or notes
                            const newCard = renderStepCard(step);
                            existing.replaceWith(newCard);
                        }
                    }
                });
            }

            // Update the live browser view with the latest screenshot
            const latestWithScreenshot = [...data.steps].reverse().find(s => s.screenshot_base64);
            if (latestWithScreenshot) {
                const img = document.getElementById('job-screenshot');
                const placeholder = document.getElementById('job-screenshot-placeholder');
                const urlEl = document.getElementById('job-screenshot-url');
                if (img && placeholder) {
                    img.src = 'data:image/png;base64,' + latestWithScreenshot.screenshot_base64;
                    img.style.display = 'block';
                    placeholder.style.display = 'none';
                }
                if (urlEl && latestWithScreenshot.url) {
                    urlEl.textContent = latestWithScreenshot.url;
                }
            }
        } else {
            if (loadedStepNumbers.size === 0) {
                container.innerHTML = '<div style="color: var(--text-dim); padding: 0.5rem;">No navigation steps recorded yet.</div>';
            }
        }
    } catch (err) {
        console.error('Failed to load steps:', err);
        if (loadedStepNumbers.size === 0) {
            container.innerHTML = '<div style="color: var(--error);">Failed to load steps: ' + escapeHtml(err.message) + '</div>';
        }
    }
}

async function refreshJobDetails(jobId) {
    try {
        const resp = await fetch(`/api/v1/jobs/${jobId}`, {
            headers: { 'X-API-Key': apiKey },
        });
        const job = await resp.json();

        // Update status fields
        const statusEl = document.getElementById('job-status');
        if (statusEl) statusEl.innerHTML = `<span class="tag ${getStatusClass(job.status)}">${job.status}</span>`;

        const phaseEl = document.getElementById('job-phase');
        if (phaseEl) phaseEl.textContent = job.current_phase;

        const progressEl = document.getElementById('job-progress');
        if (progressEl) progressEl.textContent = Math.round(job.progress_percent) + '%';

        const updatedEl = document.getElementById('job-updated');
        if (updatedEl) updatedEl.textContent = new Date(job.updated_at).toLocaleString();

        const msgEl = document.getElementById('job-progress-message');
        if (msgEl) msgEl.textContent = job.progress_message || 'Waiting...';

        // Update error
        const errorEl = document.getElementById('job-error');
        if (errorEl) {
            if (job.error_message) {
                errorEl.textContent = job.error_message;
                errorEl.style.display = '';
            } else {
                errorEl.style.display = 'none';
            }
        }

        // Update found URLs
        const urlsContainer = document.getElementById('job-found-urls');
        if (urlsContainer && job.found_urls && job.found_urls.length > 0) {
            urlsContainer.style.display = '';
            document.getElementById('job-found-urls-count').textContent = job.found_urls.length;
            document.getElementById('job-found-urls-list').innerHTML = job.found_urls.map(u =>
                `<li style="word-break: break-all;"><a href="${u}" target="_blank" style="color: var(--accent);">${u}</a></li>`
            ).join('');
        }

        // Update downloaded files
        const dlContainer = document.getElementById('job-downloaded-files');
        if (dlContainer && job.downloaded_files && job.downloaded_files.length > 0) {
            dlContainer.style.display = '';
            document.getElementById('job-downloaded-count').textContent = job.downloaded_files.length;
            document.getElementById('job-downloaded-list').innerHTML = job.downloaded_files.map(f =>
                `<li style="word-break: break-all;"><code>${f}</code></li>`
            ).join('');
        }

        // Update final paths
        const fpContainer = document.getElementById('job-final-paths');
        if (fpContainer && job.final_paths && job.final_paths.length > 0) {
            fpContainer.style.display = '';
            document.getElementById('job-final-count').textContent = job.final_paths.length;
            document.getElementById('job-final-list').innerHTML = job.final_paths.map(f =>
                `<li style="word-break: break-all;"><code>${f}</code></li>`
            ).join('');
        }

        // Load latest steps (which includes screenshots)
        await loadJobSteps(jobId);
        await loadJobLatestScreenshot(jobId);

        // Render result banner for terminal jobs
        renderResultBanner(job);

        // Stop live updates if job completed, do final data load
        if (!isActive(job.status)) {
            stopLiveUpdates();
            await refreshLogs();
            await loadNotes();
            // Remove LIVE indicators
            const indicators = document.querySelectorAll('[id="job-live-indicator"], [style*="animation: pulse"]');
            indicators.forEach(el => el.remove());
        }
    } catch (err) {
        console.error('Failed to refresh job:', err);
    }
}

let logSeenIds = new Set();

function startLiveUpdates(jobId) {
    stopLiveUpdates();

    // Poll for job state + logs as fallback every 2s (WebSocket handles real-time)
    screenshotRefreshInterval = setInterval(async () => {
        await refreshJobDetails(jobId);
        await refreshLogs();
    }, 2000);
}

function stopLiveUpdates() {
    if (screenshotRefreshInterval) {
        clearInterval(screenshotRefreshInterval);
        screenshotRefreshInterval = null;
    }
    logSeenIds.clear();
}

// Reconnect handler: reload data without destroying modal state
document.addEventListener('ws-reconnected', () => {
    if (currentJobId) {
        refreshJobDetails(currentJobId);
        refreshLogs();
    }
    refreshJobs();
});

function toggleRawLogs(enabled) {
    showRawLogs = enabled;
    logSeenIds.clear();
    refreshLogs();
}

function appendLogLine(log) {
    const logsEl = document.getElementById('job-logs');
    if (!logsEl) return;

    if (showRawLogs && !['claude', 'claude_output'].includes(log.source)) {
        return;
    }

    // Clear placeholder
    if (logsEl.querySelector('[style*="var(--text-dim)"]') && logsEl.children.length === 1) {
        logsEl.innerHTML = '';
    }

    const div = document.createElement('div');
    if (showRawLogs) {
        div.style.cssText = 'white-space: pre-wrap;';
        div.textContent = log.message;
    } else if (log.source === 'notes') {
        const time = new Date(log.timestamp).toLocaleTimeString();
        div.style.cssText = 'color: #4ecdc4; padding: 0.2rem 0.4rem; background: rgba(78,205,196,0.08); border-radius: 0.2rem; margin: 0.1rem 0;';
        div.innerHTML = `<span style="color: #555;">[${time}]</span> <span style="color: #4ecdc4;">[notes]</span> ${escapeHtml(log.message)}`;
    } else {
        const time = new Date(log.timestamp).toLocaleTimeString();
        const levelClass = log.level === 'ERROR' ? 'color: #ff6b6b;' :
                           log.level === 'WARNING' ? 'color: #ffd93d;' :
                           log.level === 'DEBUG' ? 'color: #555;' : '';
        const sourceTag = log.source ? `<span style="color: var(--accent);">[${log.source}]</span> ` : '';
        div.style.cssText = levelClass;
        div.innerHTML = `<span style="color: #555;">[${time}]</span> ${sourceTag}${escapeHtml(log.message)}`;
    }
    logsEl.appendChild(div);

    // Auto-scroll to bottom
    logsEl.scrollTop = logsEl.scrollHeight;
}

function renderResultBanner(job) {
    const existing = document.getElementById('job-result-banner');
    if (existing) existing.remove();

    if (!['complete', 'failed', 'cancelled'].includes(job.status)) return;

    const banner = document.createElement('div');
    banner.id = 'job-result-banner';

    if (job.status === 'complete') {
        const files = job.final_paths && job.final_paths.length > 0 ? job.final_paths :
                      (job.downloaded_files || []);
        banner.style.cssText = 'padding: 1rem; background: rgba(74,222,128,0.15); border: 1px solid var(--success); border-radius: 0.5rem; margin-bottom: 1rem;';
        let html = '<div style="font-weight: 600; color: var(--success); margin-bottom: 0.5rem;">Download Complete</div>';
        if (files.length > 0) {
            files.forEach(f => {
                html += `<div style="font-family: monospace; font-size: 0.85rem; word-break: break-all;">${escapeHtml(f)}</div>`;
            });
        }
        if (job.file_operation && job.file_operation !== 'copy') {
            html += `<div style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.5rem;">Operation: ${escapeHtml(job.file_operation)}</div>`;
        }
        banner.innerHTML = html;
    } else {
        banner.style.cssText = 'padding: 1rem; background: rgba(239,68,68,0.15); border: 1px solid var(--error); border-radius: 0.5rem; margin-bottom: 1rem;';
        let html = `<div style="font-weight: 600; color: var(--error);">Job ${job.status === 'failed' ? 'Failed' : 'Cancelled'}</div>`;
        if (job.error_message) {
            html += `<div style="margin-top: 0.5rem;">${escapeHtml(job.error_message)}</div>`;
        }
        banner.innerHTML = html;
    }

    const details = document.getElementById('job-details');
    if (details) details.prepend(banner);
}

function closeModal() {
    stopLiveUpdates();
    currentJobId = null;
    loadedStepNumbers = new Set();
    document.getElementById('job-modal').style.display = 'none';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Handle WebSocket job updates
const originalHandleMessage = handleMessage;
handleMessage = function(data) {
    originalHandleMessage(data);
    if (data.type === 'job_update') {
        // Update the specific job row
        const row = document.getElementById(`job-${data.job_id}`);
        if (row) {
            // Refresh just this job or do a full refresh for simplicity
            refreshJobs();
        }
    }
    if (data.type === 'job_step' && currentJobId && data.job_id === currentJobId) {
        const step = {
            step_number: data.step_number,
            action: data.action,
            observation: data.observation,
            url: data.url,
            is_error: data.is_error,
            notes: data.notes || [],
            timestamp: data.timestamp,
            screenshot_base64: data.screenshot_base64 || null,
        };
        const container = document.getElementById('job-step-cards');
        if (container) {
            if (!loadedStepNumbers.has(step.step_number)) {
                loadedStepNumbers.add(step.step_number);
                if (container.querySelector('[style*="No steps yet"]') || container.querySelector('[style*="No navigation steps"]')) {
                    container.innerHTML = '';
                }
                container.appendChild(renderStepCard(step));
            } else {
                const existing = document.getElementById(`step-card-${step.step_number}`);
                if (existing) {
                    const hasScreenshot = existing.querySelector('img');
                    const hasNotes = existing.querySelector('[data-step-notes]');
                    const needsUpdate = (step.screenshot_base64 && !hasScreenshot) ||
                                        (step.notes && step.notes.length > 0 && !hasNotes);
                    if (needsUpdate) {
                        const newCard = renderStepCard(step);
                        existing.replaceWith(newCard);
                    }
                }
            }
            // Update browser view with step screenshot
            if (step.screenshot_base64) {
                const img = document.getElementById('job-screenshot');
                const placeholder = document.getElementById('job-screenshot-placeholder');
                const urlEl = document.getElementById('job-screenshot-url');
                if (img && placeholder) {
                    img.src = 'data:image/png;base64,' + step.screenshot_base64;
                    img.style.display = 'block';
                    placeholder.style.display = 'none';
                }
                if (urlEl && step.url) {
                    urlEl.textContent = step.url;
                }
            }
        }
    }
    if (data.type === 'job_screenshot' && currentJobId && data.job_id === currentJobId) {
        if (data.data_base64) {
            const img = document.getElementById('job-screenshot');
            const placeholder = document.getElementById('job-screenshot-placeholder');
            const urlEl = document.getElementById('job-screenshot-url');
            if (img && placeholder) {
                img.src = 'data:image/png;base64,' + data.data_base64;
                img.style.display = 'block';
                placeholder.style.display = 'none';
            }
            if (urlEl && data.url) {
                urlEl.textContent = data.url;
            }

            // Attach screenshot to matching step card
            if (data.step_number) {
                const stepCard = document.getElementById(`step-card-${data.step_number}`);
                if (stepCard) {
                    // Remove placeholder if present
                    const ph = stepCard.querySelector('.step-screenshot-placeholder');
                    if (ph) ph.remove();

                    if (!stepCard.querySelector('img')) {
                        const imgDiv = document.createElement('div');
                        imgDiv.style.cssText = 'margin-bottom: 0.5rem; cursor: pointer;';
                        imgDiv.onclick = function() {
                            const i = this.querySelector('img');
                            if (i) i.style.maxHeight = i.style.maxHeight === 'none' ? '200px' : 'none';
                        };
                        imgDiv.innerHTML = `<img src="data:image/png;base64,${data.data_base64}" style="width: 100%; max-height: 200px; object-fit: contain; border-radius: 0.25rem; background: #000;">`;
                        const header = stepCard.children[0];
                        if (header) header.after(imgDiv);
                    }
                }
            }
        }
    }
    if (data.type === 'job_log' && currentJobId && data.job_id === currentJobId) {
        if (logSeenIds.has(data.id)) return;
        logSeenIds.add(data.id);
        appendLogLine(data);
    }
};

// Auto-refresh job queue every 7 seconds
setInterval(() => refreshJobs(), 7000);

function timeAgo(dateStr) {
    const now = new Date();
    const date = new Date(dateStr);
    const seconds = Math.floor((now - date) / 1000);
    if (seconds < 60) return 'just now';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h ago`;
    const days = Math.floor(hours / 24);
    return `${days}d ago`;
}

async function loadNotes() {
    const notesEl = document.getElementById('job-notes');
    if (!notesEl || !currentJobId) return;

    try {
        // Fetch this job's logs and filter for learning entries
        const resp = await fetch(`/api/v1/jobs/${currentJobId}/logs?limit=500`, {
            headers: { 'X-API-Key': apiKey },
        });
        const data = await resp.json();

        const learnings = (data.logs || []).filter(l => l.source === 'learning');

        if (learnings.length > 0) {
            const typeColors = {
                'navigation_tip': '#4ecdc4',
                'obstacle': '#ff6b6b',
                'workaround': '#95e1d3',
                'download_method': '#a8d8ea',
                'source_quality': '#ffd93d',
                'site_structure': '#c9b1ff',
            };
            const typeIcons = {
                'navigation_tip': 'Tip',
                'obstacle': 'Obstacle',
                'workaround': 'Workaround',
                'download_method': 'Download',
                'source_quality': 'Quality',
                'site_structure': 'Structure',
            };

            notesEl.innerHTML = learnings.map(log => {
                // Parse "[type] content" from log message
                const match = log.message.match(/^\[(\w+)\]\s*(.+)$/s);
                const noteType = match ? match[1] : 'note';
                const content = match ? match[2] : log.message;
                const color = typeColors[noteType] || 'var(--text-dim)';
                const icon = typeIcons[noteType] || noteType.replace(/_/g, ' ');
                const timestamp = new Date(log.timestamp).toLocaleString();
                const relative = timeAgo(log.timestamp);
                return `
                    <div style="padding: 0.75rem; margin-bottom: 0.5rem; background: var(--bg); border-radius: 0.25rem; border-left: 3px solid ${color};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; color: ${color};">${escapeHtml(icon)}</span>
                            <span style="font-size: 0.7rem; color: var(--text-dim);" title="${timestamp}">${relative}</span>
                        </div>
                        <div style="margin-top: 0.25rem; font-size: 0.85rem;">${escapeHtml(content)}</div>
                    </div>`;
            }).join('');
        } else {
            notesEl.innerHTML = '<div style="color: var(--text-dim);">No agent notes for this job yet.</div>';
        }
    } catch (err) {
        notesEl.innerHTML = `<div style="color: #ff6b6b;">Failed to load notes: ${err.message}</div>`;
    }
}

async function refreshLogs() {
    const logsEl = document.getElementById('job-logs');
    if (!logsEl || !currentJobId) return;

    try {
        const resp = await fetch(`/api/v1/jobs/${currentJobId}/logs?limit=500`, {
            headers: { 'X-API-Key': apiKey },
        });
        const data = await resp.json();

        if (data.logs && data.logs.length > 0) {
            logsEl.innerHTML = '';
            data.logs.forEach(log => {
                logSeenIds.add(log.id);
                appendLogLine(log);
            });
        } else {
            logsEl.innerHTML = '<div style="color: var(--text-dim);">Waiting for output...</div>';
        }
    } catch (err) {
        logsEl.innerHTML = `<div style="color: #ff6b6b;">Failed to load logs: ${err.message}</div>`;
    }
}

// Close modal on escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
});
</script>
{% endblock %}
