{% extends "base.html" %}

{% block title %}Jobs - Graboid{% endblock %}

{% block content %}
<h1>Job Queue</h1>

<div class="grid-2">
    <div class="card">
        <h2>Submit New Job</h2>
        <form id="job-form">
            <label for="prompt">Task Description</label>
            <textarea id="prompt" name="prompt" rows="3" placeholder="Find and download the latest release of..." required></textarea>

            <label for="source_url">Starting URL (optional)</label>
            <input type="url" id="source_url" name="source_url" placeholder="https://example.com">

            <label for="destination_path">Destination Path</label>
            <input type="text" id="destination_path" name="destination_path" placeholder="./downloads" value="./downloads">

            <div class="grid-2">
                <div>
                    <label for="file_operation">File Operation</label>
                    <select id="file_operation" name="file_operation">
                        <option value="copy">Copy</option>
                        <option value="hardlink">Hard Link</option>
                        <option value="symlink">Symbolic Link</option>
                        <option value="reflink">Reflink (CoW)</option>
                        <option value="path_only">Path Only</option>
                    </select>
                </div>
                <div>
                    <label for="priority">Priority</label>
                    <input type="number" id="priority" name="priority" value="0" min="-10" max="10">
                </div>
            </div>

            <label for="file_filter">File Filter (glob patterns, one per line)</label>
            <textarea id="file_filter" name="file_filter" rows="2" placeholder="*.mkv&#10;*.mp4"></textarea>

            <button type="submit">Submit Job</button>
        </form>
        <div id="submit-result" style="margin-top: 1rem;"></div>
    </div>

    <div class="card">
        <h2>API Access</h2>
        <p style="color: var(--text-dim); margin-bottom: 1rem;">Use the API to submit jobs programmatically.</p>

        <label>API Key</label>
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
            <input type="password" id="api-key" value="{{ api_key }}" readonly style="font-family: monospace; flex: 1;">
            <button type="button" onclick="toggleApiKey()" class="secondary" style="padding: 0.5rem 1rem;">Show</button>
            <button type="button" onclick="copyApiKey()" class="secondary" style="padding: 0.5rem 1rem;">Copy</button>
        </div>

        <label>Example Request</label>
        <pre style="background: var(--bg); padding: 1rem; border-radius: 0.25rem; overflow-x: auto; font-size: 0.8rem;">
curl -X POST {{ request.url.scheme }}://{{ request.url.netloc }}/api/v1/jobs \
  -H "X-API-Key: YOUR_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "Download latest release",
    "source_url": "https://example.com"
  }'</pre>

        <label style="margin-top: 1rem;">Endpoints</label>
        <table style="font-size: 0.875rem;">
            <tr><td><code>POST /api/v1/jobs</code></td><td>Submit job</td></tr>
            <tr><td><code>GET /api/v1/jobs</code></td><td>List jobs</td></tr>
            <tr><td><code>GET /api/v1/jobs/{id}</code></td><td>Get job details</td></tr>
            <tr><td><code>DELETE /api/v1/jobs/{id}</code></td><td>Cancel job</td></tr>
            <tr><td><code>GET /api/v1/jobs/{id}/stream</code></td><td>SSE progress stream</td></tr>
        </table>
    </div>
</div>

<div class="card">
    <h2>Job Queue</h2>
    <div style="margin-bottom: 1rem;">
        <button type="button" onclick="refreshJobs()" class="secondary">Refresh</button>
    </div>
    <table id="jobs-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Status</th>
                <th>Progress</th>
                <th>Task</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="jobs-tbody">
            {% for job in jobs %}
            <tr id="job-{{ job.id }}">
                <td><code title="{{ job.id }}">{{ job.id[:8] }}</code></td>
                <td>
                    <span class="tag
                        {% if job.status.value == 'complete' %}success
                        {% elif job.status.value == 'failed' or job.status.value == 'cancelled' %}error
                        {% elif job.status.value in ['running', 'browsing', 'downloading', 'extracting', 'copying'] %}warning
                        {% endif %}">
                        {{ job.status.value }}
                    </span>
                </td>
                <td>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="flex: 1; background: var(--bg-light); border-radius: 0.25rem; height: 8px;">
                            <div style="width: {{ job.progress_percent }}%; background: var(--accent); height: 100%; border-radius: 0.25rem; transition: width 0.3s;"></div>
                        </div>
                        <span style="font-size: 0.75rem; color: var(--text-dim);">{{ "%.0f"|format(job.progress_percent) }}%</span>
                    </div>
                    {% if job.progress_message %}
                    <div style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.25rem;">{{ job.progress_message[:50] }}</div>
                    {% endif %}
                </td>
                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">{{ job.prompt[:50] }}{% if job.prompt|length > 50 %}...{% endif %}</td>
                <td style="font-size: 0.875rem; color: var(--text-dim);">{{ job.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                    {% if job.status.value in ['pending', 'running', 'browsing', 'downloading', 'extracting', 'copying'] %}
                    <button type="button" onclick="cancelJob('{{ job.id }}')" class="secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Cancel</button>
                    {% else %}
                    <button type="button" onclick="requeueJob('{{ job.id }}')" class="secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Re-queue</button>
                    {% endif %}
                    <button type="button" onclick="viewJob('{{ job.id }}')" class="secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View</button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" style="text-align: center; color: var(--text-dim); padding: 2rem;">No jobs in queue</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Job Details Modal -->
<div id="job-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; padding: 2rem;">
    <div style="max-width: 800px; margin: 0 auto; background: var(--bg-card); border-radius: 0.5rem; padding: 1.5rem; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2>Job Details</h2>
            <button type="button" onclick="closeModal()" class="secondary">Close</button>
        </div>
        <div id="job-details"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const apiKey = "{{ api_key }}";

function toggleApiKey() {
    const input = document.getElementById('api-key');
    input.type = input.type === 'password' ? 'text' : 'password';
}

function copyApiKey() {
    navigator.clipboard.writeText(apiKey);
    alert('API key copied to clipboard');
}

document.getElementById('job-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const resultDiv = document.getElementById('submit-result');

    const fileFilter = form.file_filter.value.split('\n').filter(f => f.trim());

    const payload = {
        prompt: form.prompt.value,
        source_url: form.source_url.value,
        destination_path: form.destination_path.value,
        file_operation: form.file_operation.value,
        priority: parseInt(form.priority.value),
        file_filter: fileFilter,
    };

    try {
        const resp = await fetch('/api/v1/jobs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-API-Key': apiKey,
            },
            body: JSON.stringify(payload),
        });

        const data = await resp.json();

        if (resp.ok) {
            resultDiv.innerHTML = `<div class="alert success">Job submitted: ${data.id}</div>`;
            form.reset();
            await refreshJobs();
        } else {
            resultDiv.innerHTML = `<div class="alert error">Error: ${data.detail || data.error}</div>`;
        }
    } catch (err) {
        resultDiv.innerHTML = `<div class="alert error">Error: ${err.message}</div>`;
    }
});

async function refreshJobs() {
    try {
        const resp = await fetch('/api/v1/jobs?limit=50', {
            headers: { 'X-API-Key': apiKey },
        });
        const data = await resp.json();

        const tbody = document.getElementById('jobs-tbody');
        if (data.jobs && data.jobs.length > 0) {
            tbody.innerHTML = data.jobs.map(job => `
                <tr id="job-${job.id}">
                    <td><code title="${job.id}">${job.id.substring(0, 8)}</code></td>
                    <td>
                        <span class="tag ${getStatusClass(job.status)}">
                            ${job.status}
                        </span>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="flex: 1; background: var(--bg-light); border-radius: 0.25rem; height: 8px;">
                                <div style="width: ${job.progress_percent}%; background: var(--accent); height: 100%; border-radius: 0.25rem; transition: width 0.3s;"></div>
                            </div>
                            <span style="font-size: 0.75rem; color: var(--text-dim);">${Math.round(job.progress_percent)}%</span>
                        </div>
                        ${job.progress_message ? `<div style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.25rem;">${job.progress_message.substring(0, 50)}</div>` : ''}
                    </td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${job.prompt.substring(0, 50)}${job.prompt.length > 50 ? '...' : ''}</td>
                    <td style="font-size: 0.875rem; color: var(--text-dim);">${new Date(job.created_at).toLocaleString()}</td>
                    <td>
                        ${isActive(job.status)
                            ? `<button type="button" onclick="cancelJob('${job.id}')" class="secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Cancel</button>`
                            : `<button type="button" onclick="requeueJob('${job.id}')" class="secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Re-queue</button>`}
                        <button type="button" onclick="viewJob('${job.id}')" class="secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View</button>
                    </td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-dim); padding: 2rem;">No jobs in queue</td></tr>';
        }
    } catch (err) {
        console.error('Failed to refresh jobs:', err);
    }
}

function getStatusClass(status) {
    if (status === 'complete') return 'success';
    if (status === 'failed' || status === 'cancelled') return 'error';
    if (['running', 'browsing', 'downloading', 'extracting', 'copying'].includes(status)) return 'warning';
    return '';
}

function isActive(status) {
    return ['pending', 'running', 'browsing', 'downloading', 'extracting', 'copying'].includes(status);
}

async function cancelJob(jobId) {
    if (!confirm('Cancel this job?')) return;

    try {
        const resp = await fetch(`/api/v1/jobs/${jobId}`, {
            method: 'DELETE',
            headers: { 'X-API-Key': apiKey },
        });

        if (resp.ok) {
            await refreshJobs();
        } else {
            const data = await resp.json();
            alert('Failed to cancel: ' + (data.detail || 'Unknown error'));
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

async function requeueJob(jobId) {
    try {
        // Fetch the original job details
        const resp = await fetch(`/api/v1/jobs/${jobId}`, {
            headers: { 'X-API-Key': apiKey },
        });

        if (!resp.ok) {
            alert('Failed to fetch job details');
            return;
        }

        const job = await resp.json();

        // Create a new job with the same parameters
        const payload = {
            prompt: job.prompt,
            source_url: job.source_url || '',
            destination_path: job.destination_path || '',
            file_operation: job.file_operation || 'copy',
            priority: job.priority || 0,
            file_filter: job.file_filter || [],
            credential_name: job.credential_name || null,
            metadata: job.metadata || {},
        };

        const createResp = await fetch('/api/v1/jobs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-API-Key': apiKey,
            },
            body: JSON.stringify(payload),
        });

        if (createResp.ok) {
            const newJob = await createResp.json();
            document.getElementById('submit-result').innerHTML =
                `<div class="alert success">Job re-queued: ${newJob.id}</div>`;
            await refreshJobs();
        } else {
            const data = await createResp.json();
            alert('Failed to re-queue: ' + (data.detail || 'Unknown error'));
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

let currentJobId = null;
let screenshotRefreshInterval = null;

async function viewJob(jobId) {
    currentJobId = jobId;

    try {
        const resp = await fetch(`/api/v1/jobs/${jobId}`, {
            headers: { 'X-API-Key': apiKey },
        });
        const job = await resp.json();

        const details = document.getElementById('job-details');
        details.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                <div>
                    <table style="width: 100%;">
                        <tr><td style="color: var(--text-dim); width: 120px;">ID</td><td><code>${job.id.substring(0, 8)}</code></td></tr>
                        <tr><td style="color: var(--text-dim);">Status</td><td><span class="tag ${getStatusClass(job.status)}">${job.status}</span></td></tr>
                        <tr><td style="color: var(--text-dim);">Phase</td><td>${job.current_phase}</td></tr>
                        <tr><td style="color: var(--text-dim);">Progress</td><td>${Math.round(job.progress_percent)}%</td></tr>
                        <tr><td style="color: var(--text-dim);">Updated</td><td>${new Date(job.updated_at).toLocaleString()}</td></tr>
                    </table>

                    <div style="margin-top: 1rem; padding: 0.75rem; background: var(--bg); border-radius: 0.25rem;">
                        <div style="color: var(--text-dim); font-size: 0.75rem; margin-bottom: 0.25rem;">Current Action</div>
                        <div id="job-progress-message">${job.progress_message || 'Waiting...'}</div>
                    </div>

                    ${job.error_message ? `<div class="alert error" style="margin-top: 1rem;">${escapeHtml(job.error_message)}</div>` : ''}

                    <div style="margin-top: 1rem;">
                        <div style="color: var(--text-dim); font-size: 0.75rem; margin-bottom: 0.25rem;">Task</div>
                        <div>${escapeHtml(job.prompt)}</div>
                    </div>

                    ${job.source_url ? `
                    <div style="margin-top: 1rem;">
                        <div style="color: var(--text-dim); font-size: 0.75rem; margin-bottom: 0.25rem;">Source URL</div>
                        <div style="word-break: break-all;"><a href="${job.source_url}" target="_blank" style="color: var(--accent);">${job.source_url}</a></div>
                    </div>
                    ` : ''}
                </div>

                <div>
                    <div style="color: var(--text-dim); font-size: 0.75rem; margin-bottom: 0.5rem;">Latest Screenshot</div>
                    <div id="job-screenshot-container" style="background: #000; border-radius: 0.5rem; aspect-ratio: 16/10; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        <div id="job-screenshot-placeholder" style="color: var(--text-dim);">No screenshots yet</div>
                        <img id="job-screenshot" style="display: none; max-width: 100%; max-height: 100%; object-fit: contain;">
                    </div>
                    <div id="job-screenshot-url" style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.5rem; word-break: break-all;"></div>
                </div>
            </div>

            <div style="margin-top: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>Navigation Steps</h3>
                    <button type="button" onclick="loadJobSteps('${job.id}')" class="secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Refresh</button>
                </div>
                <div id="job-steps" style="margin-top: 0.5rem; max-height: 300px; overflow-y: auto;">
                    <div style="color: var(--text-dim);">Loading steps...</div>
                </div>
            </div>

            ${job.found_urls && job.found_urls.length > 0 ? `
                <h3 style="margin-top: 1.5rem;">Found URLs (${job.found_urls.length})</h3>
                <ul style="margin-top: 0.5rem; padding-left: 1.5rem; max-height: 150px; overflow-y: auto;">
                    ${job.found_urls.map(u => `<li style="word-break: break-all;"><a href="${u}" target="_blank" style="color: var(--accent);">${u}</a></li>`).join('')}
                </ul>
            ` : ''}

            ${job.downloaded_files && job.downloaded_files.length > 0 ? `
                <h3 style="margin-top: 1.5rem;">Downloaded Files (${job.downloaded_files.length})</h3>
                <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                    ${job.downloaded_files.map(f => `<li style="word-break: break-all;"><code>${f}</code></li>`).join('')}
                </ul>
            ` : ''}

            ${job.final_paths && job.final_paths.length > 0 ? `
                <h3 style="margin-top: 1.5rem;">Final Paths (${job.final_paths.length})</h3>
                <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                    ${job.final_paths.map(f => `<li style="word-break: break-all;"><code>${f}</code></li>`).join('')}
                </ul>
            ` : ''}

            <div style="margin-top: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>Logs</h3>
                    <button type="button" onclick="refreshLogs()" class="secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Refresh</button>
                </div>
                <div id="job-logs" style="margin-top: 0.5rem; background: var(--bg); border-radius: 0.25rem; padding: 0.75rem; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.75rem;">
                    <div style="color: var(--text-dim);">Loading logs...</div>
                </div>
            </div>

            <div style="margin-top: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>Agent Notes</h3>
                    <button type="button" onclick="loadNotes()" class="secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Refresh</button>
                </div>
                <div id="job-notes" style="margin-top: 0.5rem;">
                    <div style="color: var(--text-dim);">Loading notes...</div>
                </div>
            </div>
        `;

        document.getElementById('job-modal').style.display = 'block';

        // Load screenshots, steps, logs, and notes
        await loadJobScreenshots(jobId);
        await loadJobSteps(jobId);
        await refreshLogs();
        await loadNotes();

        // Start auto-refresh if job is active
        if (isActive(job.status)) {
            startScreenshotRefresh(jobId);
        }
    } catch (err) {
        alert('Error loading job: ' + err.message);
    }
}

async function loadJobScreenshots(jobId) {
    try {
        const resp = await fetch(`/api/v1/jobs/${jobId}/screenshots`, {
            headers: { 'X-API-Key': apiKey },
        });
        const data = await resp.json();

        if (data.screenshots && data.screenshots.length > 0) {
            const latest = data.screenshots[data.screenshots.length - 1];
            const img = document.getElementById('job-screenshot');
            const placeholder = document.getElementById('job-screenshot-placeholder');
            const urlEl = document.getElementById('job-screenshot-url');

            if (latest.data_base64) {
                img.src = 'data:image/png;base64,' + latest.data_base64;
                img.style.display = 'block';
                placeholder.style.display = 'none';
            }
            if (urlEl && latest.url) {
                urlEl.textContent = latest.url;
            }
        }
    } catch (err) {
        console.error('Failed to load screenshots:', err);
    }
}

async function loadJobSteps(jobId) {
    const container = document.getElementById('job-steps');
    if (!container) return;

    try {
        const resp = await fetch(`/api/v1/jobs/${jobId}/steps`, {
            headers: { 'X-API-Key': apiKey },
        });
        const data = await resp.json();

        if (data.steps && data.steps.length > 0) {
            container.innerHTML = data.steps.map(step => `
                <div style="padding: 0.75rem; margin-bottom: 0.5rem; background: var(--bg); border-radius: 0.25rem; border-left: 3px solid ${step.is_error ? 'var(--error)' : 'var(--accent)'};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="font-weight: 600; color: ${step.is_error ? 'var(--error)' : 'var(--text)'};">
                            Step ${step.step_number}: ${escapeHtml(step.action)}
                        </div>
                        <div style="font-size: 0.7rem; color: var(--text-dim);">${new Date(step.timestamp).toLocaleTimeString()}</div>
                    </div>
                    ${step.observation ? `<div style="margin-top: 0.5rem; color: var(--text-dim); font-size: 0.85rem;">${escapeHtml(step.observation)}</div>` : ''}
                    ${step.url ? `<div style="margin-top: 0.25rem; font-size: 0.75rem; color: var(--accent); word-break: break-all;">${escapeHtml(step.url)}</div>` : ''}
                </div>
            `).join('');
        } else {
            container.innerHTML = '<div style="color: var(--text-dim); padding: 0.5rem;">No navigation steps recorded yet. Claude Chrome integration will log steps here.</div>';
        }
    } catch (err) {
        console.error('Failed to load steps:', err);
        container.innerHTML = '<div style="color: var(--error);">Failed to load steps: ' + escapeHtml(err.message) + '</div>';
    }
}

async function refreshJobDetails(jobId) {
    try {
        const resp = await fetch(`/api/v1/jobs/${jobId}`, {
            headers: { 'X-API-Key': apiKey },
        });
        const job = await resp.json();

        // Update progress message
        const msgEl = document.getElementById('job-progress-message');
        if (msgEl) {
            msgEl.textContent = job.progress_message || 'Waiting...';
        }

        // Load latest screenshot, steps, and logs
        await loadJobScreenshots(jobId);
        await loadJobSteps(jobId);
        await refreshLogs();

        // Stop refresh if job completed
        if (!isActive(job.status)) {
            stopScreenshotRefresh();
            // Refresh the full view to show final state
            viewJob(jobId);
        }
    } catch (err) {
        console.error('Failed to refresh job:', err);
    }
}

function startScreenshotRefresh(jobId) {
    stopScreenshotRefresh();
    screenshotRefreshInterval = setInterval(() => refreshJobDetails(jobId), 2000);
}

function stopScreenshotRefresh() {
    if (screenshotRefreshInterval) {
        clearInterval(screenshotRefreshInterval);
        screenshotRefreshInterval = null;
    }
}

function closeModal() {
    stopScreenshotRefresh();
    currentJobId = null;
    document.getElementById('job-modal').style.display = 'none';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Handle WebSocket job updates
const originalHandleMessage = handleMessage;
handleMessage = function(data) {
    originalHandleMessage(data);
    if (data.type === 'job_update') {
        // Update the specific job row
        const row = document.getElementById(`job-${data.job_id}`);
        if (row) {
            // Refresh just this job or do a full refresh for simplicity
            refreshJobs();
        }
    }
};

// Auto-refresh job queue every 7 seconds
setInterval(() => refreshJobs(), 7000);

function timeAgo(dateStr) {
    const now = new Date();
    const date = new Date(dateStr);
    const seconds = Math.floor((now - date) / 1000);
    if (seconds < 60) return 'just now';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h ago`;
    const days = Math.floor(hours / 24);
    return `${days}d ago`;
}

async function loadNotes() {
    const notesEl = document.getElementById('job-notes');
    if (!notesEl || !currentJobId) return;

    try {
        // Fetch this job's logs and filter for learning entries
        const resp = await fetch(`/api/v1/jobs/${currentJobId}/logs?limit=500`, {
            headers: { 'X-API-Key': apiKey },
        });
        const data = await resp.json();

        const learnings = (data.logs || []).filter(l => l.source === 'learning');

        if (learnings.length > 0) {
            const typeColors = {
                'navigation_tip': '#4ecdc4',
                'obstacle': '#ff6b6b',
                'workaround': '#95e1d3',
                'download_method': '#a8d8ea',
                'source_quality': '#ffd93d',
                'site_structure': '#c9b1ff',
            };
            const typeIcons = {
                'navigation_tip': 'Tip',
                'obstacle': 'Obstacle',
                'workaround': 'Workaround',
                'download_method': 'Download',
                'source_quality': 'Quality',
                'site_structure': 'Structure',
            };

            notesEl.innerHTML = learnings.map(log => {
                // Parse "[type] content" from log message
                const match = log.message.match(/^\[(\w+)\]\s*(.+)$/s);
                const noteType = match ? match[1] : 'note';
                const content = match ? match[2] : log.message;
                const color = typeColors[noteType] || 'var(--text-dim)';
                const icon = typeIcons[noteType] || noteType.replace(/_/g, ' ');
                const timestamp = new Date(log.timestamp).toLocaleString();
                const relative = timeAgo(log.timestamp);
                return `
                    <div style="padding: 0.75rem; margin-bottom: 0.5rem; background: var(--bg); border-radius: 0.25rem; border-left: 3px solid ${color};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; color: ${color};">${escapeHtml(icon)}</span>
                            <span style="font-size: 0.7rem; color: var(--text-dim);" title="${timestamp}">${relative}</span>
                        </div>
                        <div style="margin-top: 0.25rem; font-size: 0.85rem;">${escapeHtml(content)}</div>
                    </div>`;
            }).join('');
        } else {
            notesEl.innerHTML = '<div style="color: var(--text-dim);">No agent notes for this job yet.</div>';
        }
    } catch (err) {
        notesEl.innerHTML = `<div style="color: #ff6b6b;">Failed to load notes: ${err.message}</div>`;
    }
}

async function refreshLogs() {
    const logsEl = document.getElementById('job-logs');
    if (!logsEl || !currentJobId) return;

    try {
        const resp = await fetch(`/api/v1/jobs/${currentJobId}/logs?limit=500`, {
            headers: { 'X-API-Key': apiKey },
        });
        const data = await resp.json();

        if (data.logs && data.logs.length > 0) {
            logsEl.innerHTML = data.logs.map(log => {
                const time = new Date(log.timestamp).toLocaleTimeString();
                const levelClass = log.level === 'ERROR' ? 'color: #ff6b6b;' :
                                   log.level === 'WARNING' ? 'color: #ffd93d;' :
                                   log.level === 'DEBUG' ? 'color: #888;' : '';
                const sourceTag = log.source ? `<span style="color: var(--accent);">[${log.source}]</span> ` : '';
                return `<div style="${levelClass}"><span style="color: var(--text-dim);">[${time}]</span> ${sourceTag}${escapeHtml(log.message)}</div>`;
            }).join('');
            // Scroll to bottom
            logsEl.scrollTop = logsEl.scrollHeight;
        } else {
            logsEl.innerHTML = '<div style="color: var(--text-dim);">No logs for this job yet</div>';
        }
    } catch (err) {
        logsEl.innerHTML = `<div style="color: #ff6b6b;">Failed to load logs: ${err.message}</div>`;
    }
}

// Close modal on escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
});
</script>
{% endblock %}
